<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
        <title>Snap! Build Your Own Blocks 5.4.5</title>
        <link rel="shortcut icon" href="src/favicon.ico">
        <script type="text/javascript" src="src/morphic.js?version=2020-01-04"></script>
        <script type="text/javascript" src="src/widgets.js?version=2020-01-03"></script>
        <script type="text/javascript" src="src/blocks.js?version=2020-01-06"></script>
        <script type="text/javascript" src="src/threads.js?version=2019-12-19"></script>
        <script type="text/javascript" src="src/objects.js?version=2020-01-28"></script>
        <script type="text/javascript" src="src/gui.js?version=2020-01-28"></script>
        <script type="text/javascript" src="src/paint.js?version=2019-06-27"></script>
        <script type="text/javascript" src="src/lists.js?version=2019-12-08"></script>
        <script type="text/javascript" src="src/byob.js?version=2020-01-03"></script>
        <script type="text/javascript" src="src/tables.js?version=2020-01-03"></script>
        <script type="text/javascript" src="src/symbols.js?version=2020-01-03"></script>
        <script type="text/javascript" src="src/sketch.js?version=2019-10-09"></script>
        <script type="text/javascript" src="src/video.js?version=2019-06-27"></script>
        <script type="text/javascript" src="src/maps.js?version=2019-10-28"></script>
        <script type="text/javascript" src="src/xml.js?version=2019-06-27"></script>
        <script type="text/javascript" src="src/store.js?version=2019-12-09"></script>
        <script type="text/javascript" src="src/locale.js?version=2020-01-28"></script>
        <script type="text/javascript" src="src/cloud.js?version=2019-10-09"></script>
        <script type="text/javascript" src="src/api.js?version=2019-12-18"></script>
        <script type="text/javascript" src="src/sha512.js?version=2019-06-27"></script>
        <script type="text/javascript" src="src/FileSaver.min.js?version=2019-06-27"></script>
        <script type="text/javascript" src="src/wiseAPI.js"></script>
        <script type="text/javascript">
            var world, ide, wiseAPI;
            window.onload = function() {
              world = new WorldMorph(document.getElementById('world'));
              ide = new IDE_Morph();
              ide.openIn(world);
              ide.save = () => {
                snapData = ide.buildProjectRequest();
                saveToWISE(snapData);
              };
              ide.addMessageListener('pressStart', () => {
                snapData = ide.buildProjectRequest();
                saveToWISE(snapData);
              });
              wiseAPI = new WISEAPI();
              wiseAPI.handleComponentStateMessage = message => {
                var snapData = message.componentState.studentData.xml;
                ide.openProjectString(snapData);
              };
              loop();

              // TODO: hook into SNAP application initialized event before calling this
              wiseAPI.sendApplicationInitializedMessage();
            };
            function loop() {
              requestAnimationFrame(loop);
              world.doOneCycle();
            }
            function saveToWISE(snapData) {
              const componentState = wiseAPI.createComponentState(snapData, 'studentDataChanged');
              componentState.studentData.type = 'snap';
              try {
                wiseAPI.sendMessageToParent(componentState);
              } catch (err) {
                console.log('not posted');
              }
            }
        </script>
    </head>
    <body style="margin: 0;">
        <canvas id="world" tabindex="1" style="position: absolute;" />
    </body>
</html>
